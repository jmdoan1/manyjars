generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String   @id @default(uuid())
  clerkUserId String   @unique
  email       String   @unique
  username    String?  @unique
  displayName String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  todos Todo[]
  jars  Jar[]
  tags  Tag[]
  notes Note[]
}

enum Priority {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

model Todo {
  id          String   @id @default(uuid())
  title       String
  description String?
  aiNotes     String?  // AI-only notes, not visible to user
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  completedAt DateTime?
  dueDate     DateTime?
  priority    Priority  @default(MEDIUM)

  jars Jar[] @relation("TodoJars")
  tags Tag[] @relation("TodoTags")
}

model Jar {
  id          String   @id @default(uuid())
  name        String
  description String?
  aiNotes     String?  // AI-only notes, not visible to user

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  todos Todo[] @relation("TodoJars")
  notes Note[] @relation("NoteJars")

  // Many-to-many self-references (jars mentioned in this jar's description)
  linkedJars     JarLink[] @relation("SourceJar")
  referencedBy   JarLink[] @relation("TargetJar")
  
  // Cross-references with tags
  linkedTags     JarTagLink[] @relation("JarToTag")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
}

model Tag {
  id          String   @id @default(uuid())
  name        String
  description String?
  aiNotes     String?  // AI-only notes, not visible to user

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  todos Todo[] @relation("TodoTags")
  notes Note[] @relation("NoteTags")

  // Many-to-many self-references (tags mentioned in this tag's description)
  linkedTags     TagLink[] @relation("SourceTag")
  referencedBy   TagLink[] @relation("TargetTag")
  
  // Cross-references with jars
  linkedJars     JarTagLink[] @relation("TagToJar")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
}

// Link tables for many-to-many relationships

model JarLink {
  id          String   @id @default(uuid())
  
  sourceJarId String
  sourceJar   Jar      @relation("SourceJar", fields: [sourceJarId], references: [id], onDelete: Cascade)
  
  targetJarId String
  targetJar   Jar      @relation("TargetJar", fields: [targetJarId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([sourceJarId, targetJarId])
}

model TagLink {
  id          String   @id @default(uuid())
  
  sourceTagId String
  sourceTag   Tag      @relation("SourceTag", fields: [sourceTagId], references: [id], onDelete: Cascade)
  
  targetTagId String
  targetTag   Tag      @relation("TargetTag", fields: [targetTagId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([sourceTagId, targetTagId])
}

model JarTagLink {
  id        String   @id @default(uuid())
  
  jarId     String
  jar       Jar      @relation("JarToTag", fields: [jarId], references: [id], onDelete: Cascade)
  
  tagId     String
  tag       Tag      @relation("TagToJar", fields: [tagId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([jarId, tagId])
}

model Note {
  id          String   @id @default(uuid())
  title       String?
  content     String   // Rich text HTML
  aiNotes     String?  // AI-only notes, not visible to user
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Implicit many-to-many relations (similar to Todo)
  jars        Jar[]    @relation("NoteJars")
  tags        Tag[]    @relation("NoteTags")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}